
name: MCP Tool Tests

on:
  pull_request:
    branches:
      - main
    paths:
      - 'src/aws-dataprocessing-mcp-server/**'

permissions:
  id-token: write
  contents: read

jobs:
  run-mcp-tests:
    name: Run MCP Tool Tests
    if: github.repository != 'awslabs/mcp'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install MCP SDK and dependencies
        run: |
          python -m pip install --upgrade pip

          # Install the actual MCP Python SDK
          pip install "mcp[cli]>=1.6.0"

          # Install MCP server dependencies from pyproject.toml
          pip install loguru>=0.7.0 pydantic>=2.10.6 boto3>=1.34.0 requests>=2.31.0 pyyaml>=6.0.0 cachetools>=5.3.0

          # Install test requirements
          cd src/aws-dataprocessing-mcp-server/integration_test
          pip install -r requirements.txt

          # Add the server package to Python path
          echo "PYTHONPATH=$(pwd)/../..:$PYTHONPATH" >> $GITHUB_ENV

          # List installed packages for debugging
          pip list | grep -E "(mcp|pydantic|loguru|boto3)"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Test credentials
        run: aws sts get-caller-identity

      - name: Check server.py path
        run: |
          ls -al src/aws-dataprocessing-mcp-server/awslabs/aws_dataprocessing_mcp_server/server.py

      - name: Verify MCP server structure
        run: |
          echo "Checking MCP server directory structure:"
          find src/aws-dataprocessing-mcp-server -name "*.py" | head -5

          # Verify the server.py exists
          if [ -f "src/aws-dataprocessing-mcp-server/awslabs/aws_dataprocessing_mcp_server/server.py" ]; then
            echo "✓ Server file found"
          else
            echo "✗ Server file not found"
            exit 1
          fi

          # Test MCP imports
          python -c "import mcp; print('✓ MCP package imported successfully')"
          python -c "from mcp.types import CallToolResult; print('✓ CallToolResult imported successfully')"

      - name: Set MCP_SERVER_PATH
        run: |
          export MCP_SERVER_PATH="$(pwd)/src/aws-dataprocessing-mcp-server/awslabs/aws_dataprocessing_mcp_server"
          echo "MCP_SERVER_PATH=${MCP_SERVER_PATH}" >> $GITHUB_ENV

      - name: Run MCP integration tests (fail on test failure)
        continue-on-error: false
        run: |
          cd src/aws-dataprocessing-mcp-server/integration_test

          echo "Starting MCP integration tests with pytest..."
          echo "Python path: $PYTHONPATH"
          echo "MCP Server path: $MCP_SERVER_PATH"

          # Run the tests with pytest
          pytest -n auto -v -k test_tool_group tests/tool_testcase_parallel.py
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_SDK_LOAD_CONFIG: 1
          MCP_SERVER_PATH: ${{ env.MCP_SERVER_PATH }}